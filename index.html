<!DOCTYPE html><!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Carta Astral – Sanación 11.11</title>
  <!-- ✅ Librerías con fallback -->
  <script defer src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.min.js"
          onerror="var s=document.createElement('script');s.defer=true;s.src='https://unpkg.com/astronomy-engine@2.1.1/astronomy.browser.min.js';document.head.appendChild(s);"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root{ --bg:#ffe6f0; --ink:#2d1b2d; --muted:#6a4c6a; --card:#ffffffcc; --accent:#9b5de5; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    .card{background:var(--card);padding:16px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    label{font-size:12px;color:var(--muted);margin:10px 0 6px;display:block}
    input, select{width:100%;padding:10px;border:1px solid #e6cfe1;border-radius:10px;background:#fff;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    canvas{max-width:100%;height:auto;background:#fff;border-radius:12px}
    footer{margin:24px 0;font-size:12px;color:var(--muted);text-align:center}
    .hint{font-size:12px;color:var(--muted)}
    .alert{background:#fff3cd;color:#7f5f00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:0 0 12px;display:none}
    .ok{background:#e9f9ef;color:#0f5132;border:1px solid #a3e4c0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>✨ Generador de Carta Astral</h1>
      <button id="btnPdf">Descargar PDF</button>
    </header>

    <div id="banner" class="alert"></div>

    <div class="grid">
      <!-- Formulario -->
      <section class="card">
        <label>Nombre completo</label>
        <input id="name" placeholder="Ej: Paola Nerina Tolosa"/>

        <div class="row3">
          <div>
            <label>Día</label>
            <select id="day"></select>
          </div>
          <div>
            <label>Mes</label>
            <select id="month">
              <option value="01">01</option><option value="02">02</option><option value="03">03</option>
              <option value="04">04</option><option value="05">05</option><option value="06">06</option>
              <option value="07">07</option><option value="08">08</option><option value="09">09</option>
              <option value="10">10</option><option value="11">11</option><option value="12">12</option>
            </select>
          </div>
          <div>
            <label>Año</label>
            <select id="year"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Hora</label>
            <select id="hour"></select>
          </div>
          <div>
            <label>Minutos</label>
            <select id="minute"></select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ciudad</label>
            <input id="city" placeholder="Mar del Plata"/>
          </div>
          <div>
            <label>País</label>
            <input id="country" placeholder="Argentina"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Latitud (decimal)</label>
            <input id="lat" placeholder="-38.0"/>
          </div>
          <div>
            <label>Longitud (decimal)</label>
            <input id="lon" placeholder="-57.56"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zona horaria (UTC±hh:mm)</label>
            <input id="tz" placeholder="-03:00"/>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:end">
            <button id="btnRender" class="secondary">Generar carta</button>
          </div>
        </div>

        <p class="hint">Tip: si no sabés lat/lon, dejá los valores por defecto. Argentina: zona horaria <b>-03:00</b>.</p>
      </section>

      <!-- Mapa -->
      <section class="card">
        <canvas id="wheel" width="800" height="800"></canvas>
        <p class="hint">La rueda zodiacal y los aspectos aparecerán aquí.</p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div id="report" class="hint">
        Completá los datos y presioná <b>Generar carta</b>.
      </div>
    </section>

    <footer>© Sanación 11.11 · Demo interpretativo</footer>
  </div>

<script defer>
window.addEventListener('load', () => {
  const banner = document.getElementById('banner');
  function show(msg, ok=false){ banner.style.display='block'; banner.className='alert'+(ok?' ok':''); banner.innerHTML=msg; }
  function hide(){ banner.style.display='none'; }

  // Poblar selects día/año/hora/minuto
  const daySel = document.getElementById('day');
  for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=o.textContent=String(d).padStart(2,'0'); daySel.appendChild(o); }
  const yearSel = document.getElementById('year');
  const thisYear = new Date().getFullYear();
  for(let y=thisYear; y>=1900; y--){ const o=document.createElement('option'); o.value=o.textContent=String(y); yearSel.appendChild(o); }
  const hourSel = document.getElementById('hour');
  for(let h=0; h<24; h++){ const o=document.createElement('option'); o.value=o.textContent=String(h).padStart(2,'0'); hourSel.appendChild(o); }
  const minSel = document.getElementById('minute');
  for(let m=0; m<60; m+=1){ const o=document.createElement('option'); o.value=o.textContent=String(m).padStart(2,'0'); minSel.appendChild(o); }

  // Valores demo (podés cambiarlos)
  daySel.value='14'; document.getElementById('month').value='12'; yearSel.value='1986';
  hourSel.value='01'; minSel.value='10';
  document.getElementById('city').value='Mar del Plata';
  document.getElementById('country').value='Argentina';
  document.getElementById('tz').value='-03:00';
  document.getElementById('lat').value='-38.0';
  document.getElementById('lon').value='-57.56';

  // Verificar librerías
  if (!window.Astronomy) {
    show('No se pudo cargar la librería astronómica. Probá recargar (Ctrl+F5).');
  } else { hide(); show('Librerías cargadas correctamente ✅', true); setTimeout(hide, 1500); }

  // === Utilidades ===
  function deg2rad(d){return d*Math.PI/180}
  function rad2deg(r){return r*180/Math.PI}
  function eclLonToAngle(lon){return deg2rad((90 - lon + 360) % 360)}
  function signOf(lon){ const s=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"]; return s[Math.floor(((lon%360)+360)%360/30)]; }
  function parseTZ(tz){ const m=/([+-])(\d{2}):(\d{2})/.exec(tz||'-03:00'); if(!m) return -3; const s=m[1]==='-'?-1:1; return s*(+m[2]+(+m[3]/60)); }
  function buildDate(day,month,year,hour,minute,tz){ const tzH=parseTZ(tz); return new Date(Date.UTC(+year, +month-1, +day, +hour - tzH, +minute)); }

  // ✅ FIX: usar GeoVector + Ecliptic (A.EclipticGeo NO existe en el bundle browser)
  async function computeLongitudes(date){
    const A = window.Astronomy;
    const bodies=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto'];
    const res={};
    for(const b of bodies){
      const vec = A.GeoVector(A.Body[b], date, true); // vector geocéntrico
      const ecl = A.Ecliptic(vec);                     // -> {elon, elat}
      res[b] = (rad2deg(ecl.elon)+360)%360;
    }
    return res;
  }

  function drawWheel(ctx,w,h,longs){
    const cx=w/2,cy=h/2,R=w*0.42,rPlan=R*0.88;
    ctx.clearRect(0,0,w,h);
    // disco
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle="#e6cfe1";ctx.stroke();
    // signos + divisiones
    const signs=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
    ctx.font="600 12px system-ui";ctx.fillStyle="#2d1b2d";
    for(let i=0;i<12;i++){
      const a=eclLonToAngle(i*30+15);
      ctx.fillText(signs[i], cx+Math.cos(a)*(R+18), cy+Math.sin(a)*(R+18));
      const d=eclLonToAngle(i*30);
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(d)*R, cy+Math.sin(d)*R);
      ctx.strokeStyle="#ead6ef";ctx.lineWidth=1;ctx.stroke();
    }
    // aspectos simples (rojo=90/180, verde=60/120)
    const glyphs={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
    const keys=Object.keys(longs);
    function aspectColor(d){d=Math.min(d,360-d); if(Math.abs(d-180)<=4||Math.abs(d-90)<=4) return '#e63946'; if(Math.abs(d-120)<=4||Math.abs(d-60)<=4) return '#2a9d8f'; return null;}
    ctx.lineWidth=1.4;
    for(let i=0;i<keys.length;i++){
      for(let j=i+1;j<keys.length;j++){
        const a=longs[keys[i]], b=longs[keys[j]]; const col=aspectColor(Math.abs(a-b)); if(!col) continue;
        const angA=eclLonToAngle(a), angB=eclLonToAngle(b);
        const x1=cx+Math.cos(angA)*rPlan, y1=cy+Math.sin(angA)*rPlan;
        const x2=cx+Math.cos(angB)*rPlan, y2=cy+Math.sin(angB)*rPlan;
        ctx.strokeStyle=col; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      }
    }
    // planetas
    ctx.font='20px serif'; ctx.fillStyle='#1f1142';
    for(const k of keys){
      const ang=eclLonToAngle(longs[k]); const x=cx+Math.cos(ang)*rPlan, y=cy+Math.sin(ang)*rPlan;
      ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill(); ctx.strokeStyle="#cdb0df"; ctx.stroke();
      ctx.fillStyle="#1f1142"; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(glyphs[k]||k[0], x, y);
    }
  }

  async function renderAll(){
    try{
      if(!window.Astronomy){ show('La librería astronómica no cargó. Refrescá con Ctrl+F5.'); return; }
      hide();
      const day=document.getElementById('day').value;
      const month=document.getElementById('month').value;
      const year=document.getElementById('year').value;
      const hour=document.getElementById('hour').value;
      const minute=document.getElementById('minute').value;
      const tz=document.getElementById('tz').value||'-03:00';
      const city=document.getElementById('city').value||'Mar del Plata';
      const country=document.getElementById('country').value||'Argentina';
      const name=(document.getElementById('name').value||'Consultante').trim();

      const date = buildDate(day,month,year,hour,minute,tz);
      const longs = await computeLongitudes(date);

      const canvas=document.getElementById('wheel');
      drawWheel(canvas.getContext('2d'), canvas.width, canvas.height, longs);

      const dd=`${day}/${month}/${year}`; const tt=`${hour}:${minute}`;
      document.getElementById('report').innerHTML = `<b>${name}</b><br/>Sol en ${signOf(longs.Sun)} · Luna en ${signOf(longs.Moon)}<br/>${dd} ${tt} – ${city}, ${country}`;
    }catch(err){ console.error(err); show('Error al generar la carta. Abrí la consola (F12) y pasame el mensaje.'); }
  }

  async function downloadPDF(){
    try{
      const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4'});
      pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F');
      pdf.setTextColor(45,27,45); pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
      pdf.text('Carta Astral – Sanación 11.11',40,40);
      const canvas=document.getElementById('wheel'); const img=canvas.toDataURL('image/png');
      const pageW=pdf.internal.pageSize.getWidth()-80; const ratio=pageW/canvas.width; const imgH=canvas.height*ratio;
      pdf.addImage(img,'PNG',40,60,pageW,imgH);
      const rep=document.getElementById('report'); const text=rep.innerText||rep.textContent||'';
      pdf.setFont('helvetica','normal'); pdf.setFontSize(12);
      const lines=pdf.splitTextToSize(text, pageW); let y=80+imgH;
      if(y+lines.length*14>pdf.internal.pageSize.getHeight()-60){ pdf.addPage(); pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F'); y=60; }
      pdf.text(lines,40,y); pdf.save('Carta_Astral.pdf');
    }catch(err){ console.error(err); show('No se pudo generar el PDF. Revisá la consola (F12).'); }
  }

  document.getElementById('btnRender').addEventListener('click', renderAll);
  document.getElementById('btnPdf').addEventListener('click', downloadPDF);
  // Render inicial demo
  renderAll();
});
</script>
</body>
</html>
