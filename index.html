<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Carta Astral – Sanación 11.11</title>
  <!-- Librerías: Astronomy Engine, jsPDF y html2canvas -->
  <script src="https://unpkg.com/astronomy-engine@2.1.1/astronomy.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#ffe6f0; /* rosa pastel cálido */
      --ink:#2d1b2d;
      --muted:#6a4c6a;
      --card:#ffffffcc;
      --accent:#9b5de5;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:16px}
    h1{font-weight:800;letter-spacing:.3px;margin:0;font-size:clamp(20px,3vw,28px)}
    .card{background:var(--card);backdrop-filter:saturate(120%) blur(6px);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    input,select{width:100%;padding:12px;border:1px solid #e6cfe1;border-radius:12px;background:#fff;color:var(--ink);font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{appearance:none;border:0;background:var(--accent);color:#fff;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 6px 14px rgba(155,93,229,.25)}
    button.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    .hint{font-size:12px;color:var(--muted)}
    canvas{max-width:100%;height:auto;background:#fff;border-radius:12px}
    footer{margin:28px 0 12px;color:var(--muted);font-size:12px}
    .titlebar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .badge{font-size:11px;background:#f9d8ff;color:#6b2fbf;padding:4px 8px;border-radius:999px;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>✨ Generador de Carta Astral – Sanación 11.11</h1>
      <button id="btnPdf">Descargar PDF</button>
    </header>

    <div class="grid">
      <!-- Panel de entrada -->
      <section class="card">
        <div class="titlebar"><strong>Datos de nacimiento</strong><span class="badge">Versión MVP</span></div>
        <label>Nombre completo</label>
        <input id="name" placeholder="Ej: Paola Nerina Tolosa"/>

        <div class="row">
          <div>
            <label>Fecha (DD/MM/AAAA)</label>
            <input id="date" placeholder="14/12/1986"/>
          </div>
          <div>
            <label>Hora local (HH:MM)</label>
            <input id="time" placeholder="01:10"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ciudad</label>
            <input id="city" placeholder="Mar del Plata"/>
          </div>
          <div>
            <label>País</label>
            <input id="country" placeholder="Argentina"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Latitud (decimal)</label>
            <input id="lat" placeholder="-38.0023"/>
            <div class="hint">Podés pegar coordenadas si las sabés. Si no, aproximá.</div>
          </div>
          <div>
            <label>Longitud (decimal)</label>
            <input id="lon" placeholder="-57.5562"/>
            <div class="hint">O dejá vacío para usar valores por defecto de la ciudad.</div>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zona horaria (UTC±hh:mm)</label>
            <input id="tz" placeholder="-03:00"/>
            <div class="hint">Argentina: -03:00</div>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:end">
            <button id="btnRender" class="secondary">Generar carta</button>
          </div>
        </div>

        <p class="hint">Nota: este MVP calcula <b>longitudes eclípticas precisas de planetas/luminarias</b> con Astronomy Engine. Las <b>casas</b> se dibujan con sistema de <b>Casas Iguales</b> a partir del Ascendente estimado. Es suficiente para informes interpretativos. Podés ajustar más adelante a Placidus si querés.</p>
      </section>

      <!-- Vista previa / lienzo -->
      <section class="card">
        <div class="titlebar"><strong>Mapa astrológico</strong><span class="badge">Wheel + aspectos</span></div>
        <canvas id="wheel" width="900" height="900"></canvas>
        <p class="hint">Líneas verdes: trígonos/sextiles · Líneas rojas: cuadraturas/oposiciones</p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div class="titlebar"><strong>Texto interpretativo</strong><span class="badge">Auto-generado</span></div>
      <div id="report" class="hint">Completá los datos y presioná <b>Generar carta</b> para ver el informe aquí y exportarlo a PDF.</div>
    </section>

    <footer>© Sanación 11.11 · Este generador es educativo y aproximado. Para trabajo profesional, puede integrarse efemérides avanzadas y casas Placidus.</footer>
  </div>

<script>
// ======= Utilidades =======
const A = Astronomy; // from astronomy-engine CDN

function parseTZ(tz){
  // "-03:00" -> -3 hours
  const m = /([+-])(\d{2}):(\d{2})/.exec(tz || "-03:00");
  if(!m) return -3; // default Argentina
  const s = m[1] === '-' ? -1 : 1;
  return s * (parseInt(m[2]) + parseInt(m[3])/60);
}

function parseDateTime(dstr, tstr, tzstr){
  const [dd,mm,yyyy] = dstr.split('/').map(Number);
  const [HH,MM] = tstr.split(':').map(Number);
  // Construimos fecha en UTC aplicando zona horaria
  const tzHours = parseTZ(tzstr);
  const jsDate = new Date(Date.UTC(yyyy, mm-1, dd, HH - tzHours, MM));
  return jsDate;
}

function deg2rad(d){return d*Math.PI/180}
function rad2deg(r){return r*180/Math.PI}

// Proyección simple para la rueda: 0° Aries arriba, sentido antihorario
function eclLonToAngle(lon){
  // 0° Aries en la parte superior -> 90° gráfico
  const a = (90 - lon + 360) % 360;
  return deg2rad(a);
}

function signOf(lon){
  const signs = ["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
  const idx = Math.floor(((lon%360)+360)%360 / 30);
  return signs[idx];
}

// Estimar Ascendente por búsqueda numérica sobre eclíptica: punto con alt ≈ 0 y az ≈ 90° (este)
async function estimateAscendant(date, latDeg, lonDeg){
  const observer = new A.Observer(latDeg, lonDeg, 0);
  const gst = A.SiderealTime(date); // horas sidéreas
  let bestLon = 0, bestScore = 1e9;
  for(let lon=0; lon<360; lon+=0.5){
    // eclíptica lat=0, lon variable -> convertir a RA/Dec (J2000 approx)
    const ecl = { lon: deg2rad(lon), lat: 0 };
    const obliq = deg2rad(23.4392911);
    const sinE = Math.sin(obliq), cosE = Math.cos(obliq);
    const sinLon = Math.sin(ecl.lon), cosLon = Math.cos(ecl.lon);
    const x = cosLon;
    const y = sinLon * cosE;
    const z = sinLon * sinE;
    const ra = Math.atan2(y, x); // rad
    const dec = Math.asin(z);
    // convertir a horiz (alt/az)
    const lst = gst * 15 * Math.PI/180 + deg2rad(lonDeg); // rad
    const ha = (lst - ra + Math.PI*2)%(Math.PI*2); // ángulo horario
    const lat = deg2rad(latDeg);
    const sinAlt = Math.sin(lat)*Math.sin(dec)+Math.cos(lat)*Math.cos(dec)*Math.cos(ha);
    const alt = Math.asin(sinAlt);
    const cosAz = (Math.sin(dec)-Math.sin(lat)*sinAlt)/(Math.cos(lat)*Math.cos(alt)+1e-9);
    let az = Math.acos(Math.max(-1,Math.min(1,cosAz)));
    if(Math.sin(ha)>0) az = 2*Math.PI - az; // rango 0..2pi
    const score = Math.abs(rad2deg(alt)) + Math.abs(rad2deg(az) - 90);
    if(score < bestScore){ bestScore = score; bestLon = lon; }
  }
  return bestLon; // eclíptica long del Asc
}

// Calcular longitudes eclípticas de planetas/lunas con Astronomy Engine
async function computeLongitudes(date){
  const bodies = ["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto"];
  const results = {};
  for(const b of bodies){
    const ecl = A.EclipticGeo(date, A.Body[b]); // longitud/lat geocéntrica (rad)
    const lon = (rad2deg(ecl.elon)+360)%360;
    results[b] = lon;
  }
  return results;
}

function drawWheel(ctx, w, h, longs, ascLon){
  ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2; const R=w*0.42; const rPlan=R*0.88;
  ctx.save();
  // anillo exterior
  ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle="#e9d2e5"; ctx.stroke();

  // divisiones signos
  ctx.save();
  ctx.translate(cx,cy);
  for(let i=0;i<12;i++){
    const ang = eclLonToAngle(i*30);
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(Math.cos(ang)*R, Math.sin(ang)*R);
    ctx.strokeStyle="#e8c5ec"; ctx.lineWidth=1; ctx.stroke();
  }
  ctx.restore();

  // etiquetas signos
  const signs = ["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
  ctx.fillStyle="#6a4c6a"; ctx.font = "600 14px Inter, system-ui, sans-serif";
  for(let i=0;i<12;i++){
    const lon=i*30+15; const ang=eclLonToAngle(lon);
    const rx = cx + Math.cos(ang)*(R+18);
    const ry = cy + Math.sin(ang)*(R+18);
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(signs[i], rx, ry);
  }

  // Casas iguales desde Ascendente
  if(Number.isFinite(ascLon)){
    ctx.save(); ctx.translate(cx,cy);
    for(let i=0;i<12;i++){
      const lon = (ascLon + i*30)%360; const ang=eclLonToAngle(lon);
      ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ang)*R*0.95, Math.sin(ang)*R*0.95);
      ctx.strokeStyle="#c7a1d8"; ctx.lineWidth=2; ctx.stroke();
      // número casa
      const mid = (ascLon + i*30 + 15)%360; const am=eclLonToAngle(mid);
      const rx = Math.cos(am)*R*0.65, ry=Math.sin(am)*R*0.65;
      ctx.fillStyle="#9b5de5"; ctx.font="bold 16px Inter";
      ctx.fillText(String(i+1), cx+rx, cy+ry);
    }
    ctx.restore();
  }

  // Planet glyphs (texto simple)
  const glyphs = {Sun:"☉", Moon:"☽", Mercury:"☿", Venus:"♀", Mars:"♂", Jupiter:"♃", Saturn:"♄", Uranus:"♅", Neptune:"♆", Pluto:"♇"};

  // Dibujar aspectos simples (cuadra/opos/trig/sext) entre planetas principales
  const keys = Object.keys(longs);
  function aspectColor(d){
    d = Math.min(d, 360-d);
    if(Math.abs(d-180)<=4 || Math.abs(d-90)<=4) return "#e63946"; // rojo
    if(Math.abs(d-120)<=4 || Math.abs(d-60)<=4) return "#2a9d8f"; // verde
    return null;
  }
  ctx.lineWidth=1.5;
  for(let i=0;i<keys.length;i++){
    for(let j=i+1;j<keys.length;j++){
      const a = longs[keys[i]], b = longs[keys[j]];
      const diff = Math.abs(a-b);
      const col = aspectColor(diff);
      if(!col) continue;
      const angA = eclLonToAngle(a), angB=eclLonToAngle(b);
      const x1=cx+Math.cos(angA)*rPlan, y1=cy+Math.sin(angA)*rPlan;
      const x2=cx+Math.cos(angB)*rPlan, y2=cy+Math.sin(angB)*rPlan;
      ctx.strokeStyle=col; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    }
  }

  // Planetas
  ctx.font = "20px serif"; ctx.fillStyle="#1f1142";
  for(const k of keys){
    const lon = longs[k];
    const ang = eclLonToAngle(lon);
    const x=cx+Math.cos(ang)*rPlan, y=cy+Math.sin(ang)*rPlan;
    ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fillStyle="#ffffff"; ctx.fill();
    ctx.strokeStyle="#cdb0df"; ctx.stroke();
    ctx.fillStyle="#1f1142"; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(glyphs[k]||k[0], x, y);
  }

  // Anotación Ascendente
  if(Number.isFinite(ascLon)){
    const ang=eclLonToAngle(ascLon);
    const x=cx+Math.cos(ang)*R, y=cy+Math.sin(ang)*R;
    ctx.strokeStyle="#9b5de5"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(x,y); ctx.stroke();
    ctx.fillStyle="#9b5de5"; ctx.font="bold 14px Inter";
    ctx.fillText("ASC", cx+Math.cos(ang)*(R+28), cy+Math.sin(ang)*(R+28));
  }

  ctx.restore();
}

function buildReport(name, dateStr, timeStr, place, longs){
  const sunS = signOf(longs.Sun), moonS = signOf(longs.Moon);
  return `
  <h3 style="margin:.2em 0">${name}</h3>
  <div><b>Datos:</b> ${dateStr} · ${timeStr} · ${place}</div>
  <hr style="border:none;border-top:1px solid #e6cfe1;margin:12px 0"/>
  <p><b>Sol</b> en ${sunS} · <b>Luna</b> en ${moonS}. Posiciones planetarias calculadas con Astronomy Engine (longitudes eclípticas). Casas dibujadas con sistema de Casas Iguales a partir de un Ascendente estimado.</p>
  <p class="hint">Este informe es interpretativo. Para uso profesional avanzado, se puede cambiar a Placidus/Koch e integrar efemérides Suizas.</p>
  `;
}

async function renderAll(){
  const name = document.getElementById('name').value || 'Consultante';
  const dateStr = document.getElementById('date').value || '02/10/1977';
  const timeStr = document.getElementById('time').value || '12:00';
  const city = document.getElementById('city').value || 'Mar del Plata';
  const country = document.getElementById('country').value || 'Argentina';
  const lat = parseFloat(document.getElementById('lat').value || -38.0);
  const lon = parseFloat(document.getElementById('lon').value || -57.56);
  const tz = document.getElementById('tz').value || '-03:00';

  const date = parseDateTime(dateStr, timeStr, tz);
  const longs = await computeLongitudes(date);
  const asc = await estimateAscendant(date, lat, lon);

  const canvas = document.getElementById('wheel');
  const ctx = canvas.getContext('2d');
  drawWheel(ctx, canvas.width, canvas.height, longs, asc);

  const reportHtml = buildReport(name, dateStr, timeStr, `${city}, ${country}`, longs);
  document.getElementById('report').innerHTML = reportHtml + `
  <div style="margin-top:8px;color:#6a4c6a">
    <b>Contacto Sanación 11.11</b><br/>Instagram: @sanacion11.11 · WhatsApp: +54 9 223 593-1151
  </div>`;
}

async function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({ unit:'pt', format:'a4' });

  // Fondo rosa
  pdf.setFillColor(255,230,240); // #ffe6f0
  pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F');

  // Título
  pdf.setTextColor(45,27,45);
  pdf.setFont('helvetica','bold');
  pdf.setFontSize(20);
  pdf.text('Carta Astral – Sanación 11.11', 40, 50);

  // Renderizar parte HTML a imagen
  const wrap = document.querySelector('.grid');
  const canvas = await html2canvas(wrap, {backgroundColor:'#ffe6f0', scale:2});
  const imgData = canvas.toDataURL('image/png');
  const pageWidth = pdf.internal.pageSize.getWidth() - 80;
  const ratio = pageWidth / canvas.width;
  const imgHeight = canvas.height * ratio;
  pdf.addImage(imgData,'PNG',40,70,pageWidth,imgHeight);

  // Reporte final (texto)
  const report = document.getElementById('report');
  const repCanvas = await html2canvas(report, {backgroundColor:'#ffe6f0', scale:2});
  const repImg = repCanvas.toDataURL('image/png');
  let y = 90 + imgHeight;
  if(y + 200 > pdf.internal.pageSize.getHeight()){
    pdf.addPage();
    // fondo
    pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F');
    y = 40;
  }
  pdf.addImage(repImg,'PNG',40,y,pageWidth, repCanvas.height * (pageWidth/repCanvas.width));

  pdf.save('Carta_Astral.pdf');
}

// Eventos
document.getElementById('btnRender').addEventListener('click', renderAll);
// Render demo al cargar
renderAll();

document.getElementById('btnPdf').addEventListener('click', downloadPDF);
</script>
</body>
</html>
