<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Carta Astral – Sanación 11.11</title>

  <!-- ✅ Librerías (con fallback) -->
  <script defer src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.min.js"
          onerror="var s=document.createElement('script');s.defer=true;s.src='https://unpkg.com/astronomy-engine@2.1.1/astronomy.browser.min.js';document.head.appendChild(s);">
  </script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{ --bg:#ffe6f0; --ink:#2d1b2d; --muted:#6a4c6a; --card:#ffffffcc; --accent:#9b5de5; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    .card{background:var(--card);padding:16px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    label{font-size:12px;color:var(--muted);margin:10px 0 6px;display:block}
    input{width:100%;padding:10px;border:1px solid #e6cfe1;border-radius:10px;background:#fff;color:var(--ink)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    canvas{max-width:100%;height:auto;background:#fff;border-radius:12px}
    footer{margin:24px 0;font-size:12px;color:var(--muted);text-align:center}
    .hint{font-size:12px;color:var(--muted)}
    .alert{background:#fff3cd;color:#7f5f00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:0 0 12px;display:none}
    .ok{background:#e9f9ef;color:#0f5132;border:1px solid #a3e4c0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>✨ Generador de Carta Astral</h1>
      <button id="btnPdf">Descargar PDF</button>
    </header>

    <div id="banner" class="alert"></div>

    <div class="grid">
      <!-- Formulario -->
      <section class="card">
        <label>Nombre completo</label>
        <input id="name" placeholder="Ej: Paola Nerina Tolosa"/>

        <div class="row">
          <div>
            <label>Fecha (DD/MM/AAAA)</label>
            <input id="date" placeholder="14/12/1986"/>
          </div>
          <div>
            <label>Hora local (HH:MM)</label>
            <input id="time" placeholder="01:10"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ciudad</label>
            <input id="city" placeholder="Mar del Plata"/>
          </div>
          <div>
            <label>País</label>
            <input id="country" placeholder="Argentina"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Latitud (decimal)</label>
            <input id="lat" placeholder="-38.0"/>
          </div>
          <div>
            <label>Longitud (decimal)</label>
            <input id="lon" placeholder="-57.56"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zona horaria (UTC±hh:mm)</label>
            <input id="tz" placeholder="-03:00"/>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:end">
            <button id="btnRender" class="secondary">Generar carta</button>
          </div>
        </div>

        <p class="hint">Si no conocés lat/lon, dejá valores por defecto (Mar del Plata). Zona horaria en Argentina: <b>-03:00</b>.</p>
      </section>

      <!-- Mapa -->
      <section class="card">
        <canvas id="wheel" width="800" height="800"></canvas>
        <p class="hint">Rueda zodiacal y aspectos aparecerán aquí.</p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div id="report" class="hint">
        Ingresá los datos y presioná <b>Generar carta</b> para ver el informe.
      </div>
    </section>

    <footer>© Sanación 11.11 · Demo interpretativo</footer>
  </div>

<script defer>
window.addEventListener('load', () => {
  const banner = document.getElementById('banner');
  function show(msg, ok=false){
    banner.style.display='block';
    banner.className = 'alert' + (ok ? ' ok' : '');
    banner.innerHTML = msg;
  }
  function hide(){ banner.style.display='none'; }

  // Verificar librerías
  if (!window.Astronomy) {
    show('No se pudo cargar la librería astronómica. Probá recargar la página (Ctrl+F5). Si persiste, revisá que no haya bloqueadores de contenido.');
  } else {
    hide();
    show('Librerías cargadas correctamente ✅', true);
    setTimeout(hide, 2000);
  }

  // === Utilidades ===
  function deg2rad(d){return d*Math.PI/180}
  function rad2deg(r){return r*180/Math.PI}
  function eclLonToAngle(lon){return deg2rad((90 - lon + 360) % 360)}
  function signOf(lon){
    const signs=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
    return signs[Math.floor(((lon%360)+360)%360 / 30)];
  }
  function parseTZ(tz){
    const m=/([+-])(\d{2}):(\d{2})/.exec(tz||"-03:00");
    if(!m) return -3;
    const s=m[1]==='-'?-1:1;
    return s*(+m[2]+(+m[3]/60));
  }
  function parseDateTime(dstr,tstr,tz){
    const [dd,mm,yyyy]=(dstr||'02/10/1977').split('/').map(Number);
    const [HH,MM]=(tstr||'12:00').split(':').map(Number);
    const tzH=parseTZ(tz||'-03:00');
    return new Date(Date.UTC(yyyy,mm-1,dd,HH - tzH,MM||0));
  }

  async function computeLongitudes(date){
    const A = window.Astronomy;
    const bodies=["Sun","Moon","Mercury","Venus","Mars","Jupiter","Saturn","Uranus","Neptune","Pluto"];
    const res={};
    for(const b of bodies){
      const ecl=A.EclipticGeo(date,A.Body[b]); // {elon, elat, dist}
      res[b]=(rad2deg(ecl.elon)+360)%360;
    }
    return res;
  }

  function drawWheel(ctx,w,h,longs){
    const cx=w/2,cy=h/2,R=w*0.42,rPlan=R*0.88;
    ctx.clearRect(0,0,w,h);
    // disco
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle="#e6cfe1";ctx.stroke();
    // signos
    const signs=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
    ctx.font="600 12px system-ui";ctx.fillStyle="#2d1b2d";
    for(let i=0;i<12;i++){
      const a=eclLonToAngle(i*30+15);
      ctx.fillText(signs[i], cx+Math.cos(a)*(R+18), cy+Math.sin(a)*(R+18));
      // divisiones
      const d=eclLonToAngle(i*30);
      ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(d)*R, cy+Math.sin(d)*R);
      ctx.strokeStyle="#ead6ef";ctx.lineWidth=1;ctx.stroke();
    }
    // planetas
    const glyphs={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇"};
    // aspectos simples (rojo=90/180, verde=60/120, orbe 4°)
    const keys=Object.keys(longs);
    function aspectColor(d){d=Math.min(d,360-d);
      if(Math.abs(d-180)<=4||Math.abs(d-90)<=4) return "#e63946";
      if(Math.abs(d-120)<=4||Math.abs(d-60)<=4) return "#2a9d8f";
      return null;
    }
    ctx.lineWidth=1.4;
    for(let i=0;i<keys.length;i++){
      for(let j=i+1;j<keys.length;j++){
        const a=longs[keys[i]], b=longs[keys[j]];
        const col=aspectColor(Math.abs(a-b));
        if(!col) continue;
        const angA=eclLonToAngle(a), angB=eclLonToAngle(b);
        const x1=cx+Math.cos(angA)*rPlan, y1=cy+Math.sin(angA)*rPlan;
        const x2=cx+Math.cos(angB)*rPlan, y2=cy+Math.sin(angB)*rPlan;
        ctx.strokeStyle=col; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      }
    }
    // dibujar glifos
    ctx.font="20px serif"; ctx.fillStyle="#1f1142";
    for(const k of keys){
      const ang=eclLonToAngle(longs[k]);
      const x=cx+Math.cos(ang)*rPlan, y=cy+Math.sin(ang)*rPlan;
      ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill(); ctx.strokeStyle="#cdb0df"; ctx.stroke();
      ctx.fillStyle="#1f1142"; ctx.textAlign="center"; ctx.textBaseline="middle"; ctx.fillText(glyphs[k]||k[0], x, y);
    }
  }

  async function renderAll(){
    try{
      if(!window.Astronomy){ show('La librería astronómica no cargó. Probá recargar (Ctrl+F5) o revisá bloqueadores.'); return; }
      hide();
      const name = (document.getElementById('name').value||'Consultante').trim();
      const dateStr = document.getElementById('date').value||'02/10/1977';
      const timeStr = document.getElementById('time').value||'12:00';
      const city = document.getElementById('city').value||'Mar del Plata';
      const country = document.getElementById('country').value||'Argentina';
      const tz = document.getElementById('tz').value||'-03:00';

      const date = parseDateTime(dateStr,timeStr,tz);
      if(isNaN(date.getTime())) { show('Fecha/Hora inválidas. Usá formato DD/MM/AAAA y HH:MM.'); return; }

      const longs = await computeLongitudes(date);
      const canvas = document.getElementById('wheel');
      drawWheel(canvas.getContext('2d'), canvas.width, canvas.height, longs);

      document.getElementById('report').innerHTML =
        `<b>${name}</b><br/>Sol en ${signOf(longs.Sun)} · Luna en ${signOf(longs.Moon)}<br/>${dateStr} ${timeStr} – ${city}, ${country}`;
    } catch(err){
      console.error(err);
      show('Ocurrió un error al generar la carta. Abrí la consola (F12) y pasame el mensaje para corregirlo.');
    }
  }

  async function downloadPDF(){
    try{
      const {jsPDF}=window.jspdf;
      const pdf=new jsPDF({unit:'pt', format:'a4'});
      // fondo rosa
      pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F');
      pdf.setTextColor(45,27,45); pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
      pdf.text('Carta Astral – Sanación 11.11',40,40);

      const canvas=document.getElementById('wheel');
      const img=canvas.toDataURL('image/png');
      const pageW=pdf.internal.pageSize.getWidth()-80;
      const ratio=pageW/canvas.width; const imgH=canvas.height*ratio;
      pdf.addImage(img,'PNG',40,60,pageW,imgH);

      const rep=document.getElementById('report');
      const text=rep.innerText||rep.textContent||'';
      pdf.setFont('helvetica','normal'); pdf.setFontSize(12);
      const lines = pdf.splitTextToSize(text, pageW);
      let y = 80 + imgH;
      if(y+lines.length*14 > pdf.internal.pageSize.getHeight()-60){ pdf.addPage(); pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F'); y=60; }
      pdf.text(lines,40,y);
      pdf.save('Carta_Astral.pdf');
    }catch(err){
      console.error(err);
      show('No se pudo generar el PDF. Revisá la consola (F12).');
    }
  }

  document.getElementById('btnRender').addEventListener('click', renderAll);
  document.getElementById('btnPdf').addEventListener('click', downloadPDF);
  // Render demo inicial
  renderAll();
});
</script>
</body>
</html>

