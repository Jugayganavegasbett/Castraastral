<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Carta Astral – Sanación 11.11</title>
  <!-- ✅ Librerías necesarias -->
  <script defer src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#ffe6f0; --ink:#2d1b2d; --muted:#6a4c6a;
      --card:#ffffffcc; --accent:#9b5de5;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,Arial,sans-serif}
    .wrap{max-width:1000px;margin:32px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{font-size:clamp(20px,3vw,28px);margin:0}
    .card{background:var(--card);padding:16px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .grid{display:grid;gap:16px}
    @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
    label{font-size:12px;color:var(--muted);margin:10px 0 6px;display:block}
    input{width:100%;padding:10px;border:1px solid #e6cfe1;border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
    canvas{max-width:100%;height:auto;background:#fff;border-radius:12px}
    footer{margin:24px 0;font-size:12px;color:var(--muted);text-align:center}
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>✨ Generador de Carta Astral</h1>
      <button id="btnPdf">Descargar PDF</button>
    </header>

    <div class="grid">
      <!-- Formulario -->
      <section class="card">
        <label>Nombre completo</label>
        <input id="name" placeholder="Ej: Paola Nerina Tolosa"/>

        <div class="row">
          <div>
            <label>Fecha (DD/MM/AAAA)</label>
            <input id="date" placeholder="14/12/1986"/>
          </div>
          <div>
            <label>Hora local (HH:MM)</label>
            <input id="time" placeholder="01:10"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Ciudad</label>
            <input id="city" placeholder="Mar del Plata"/>
          </div>
          <div>
            <label>País</label>
            <input id="country" placeholder="Argentina"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Latitud (decimal)</label>
            <input id="lat" placeholder="-38.0"/>
          </div>
          <div>
            <label>Longitud (decimal)</label>
            <input id="lon" placeholder="-57.56"/>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Zona horaria (UTC±hh:mm)</label>
            <input id="tz" placeholder="-03:00"/>
          </div>
          <div style="display:flex;align-items:flex-end;justify-content:end">
            <button id="btnRender" class="secondary">Generar carta</button>
          </div>
        </div>
      </section>

      <!-- Mapa -->
      <section class="card">
        <canvas id="wheel" width="800" height="800"></canvas>
        <p class="hint">Verás la rueda zodiacal y los aspectos aquí.</p>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <div id="report" class="hint">
        Ingresá tus datos y presioná <b>Generar carta</b> para ver el informe.
      </div>
    </section>

    <footer>© Sanación 11.11 · Demo interpretativo</footer>
  </div>

<script defer>
window.addEventListener('load', () => {
  const A = window.Astronomy;

  function deg2rad(d){return d*Math.PI/180}
  function rad2deg(r){return r*180/Math.PI}
  function eclLonToAngle(lon){return deg2rad((90 - lon + 360) % 360)}
  function signOf(lon){
    const signs=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];
    return signs[Math.floor(((lon%360)+360)%360 / 30)];
  }
  function parseTZ(tz){const m=/([+-])(\\d{2}):(\\d{2})/.exec(tz||\"-03:00\");if(!m)return -3;const s=m[1]==='-'?-1:1;return s*(+m[2]+(+m[3]/60));}
  function parseDateTime(dstr,tstr,tz){const[dd,mm,yyyy]=dstr.split('/').map(Number);const[HH,MM]=tstr.split(':').map(Number);const tzH=parseTZ(tz);return new Date(Date.UTC(yyyy,mm-1,dd,HH-tzH,MM));}

  async function computeLongitudes(date){
    const bodies=[\"Sun\",\"Moon\",\"Mercury\",\"Venus\",\"Mars\",\"Jupiter\",\"Saturn\",\"Uranus\",\"Neptune\",\"Pluto\"];
    const res={};
    for(const b of bodies){
      const ecl=A.EclipticGeo(date,A.Body[b]);
      res[b]=(rad2deg(ecl.elon)+360)%360;
    }
    return res;
  }

  function drawWheel(ctx,w,h,longs){
    const cx=w/2,cy=h/2,R=w*0.42,rPlan=R*0.88;
    ctx.clearRect(0,0,w,h);
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle=\"#fff\";ctx.fill();ctx.stroke();
    const signs=[\"Aries\",\"Tauro\",\"Géminis\",\"Cáncer\",\"Leo\",\"Virgo\",\"Libra\",\"Escorpio\",\"Sagitario\",\"Capricornio\",\"Acuario\",\"Piscis\"];
    ctx.font=\"12px sans-serif\";ctx.fillStyle=\"#333\";
    for(let i=0;i<12;i++){const ang=eclLonToAngle(i*30+15);ctx.fillText(signs[i],cx+Math.cos(ang)*(R+20),cy+Math.sin(ang)*(R+20));}
    const glyphs={Sun:\"☉\",Moon:\"☽\",Mercury:\"☿\",Venus:\"♀\",Mars:\"♂\",Jupiter:\"♃\",Saturn:\"♄\",Uranus:\"♅\",Neptune:\"♆\",Pluto:\"♇\"};
    for(const k in longs){const ang=eclLonToAngle(longs[k]);const x=cx+Math.cos(ang)*rPlan,y=cy+Math.sin(ang)*rPlan;ctx.fillText(glyphs[k]||k[0],x,y);}
  }

  async function renderAll(){
    const name=document.getElementById('name').value||'Consultante';
    const dateStr=document.getElementById('date').value||'02/10/1977';
    const timeStr=document.getElementById('time').value||'12:00';
    const city=document.getElementById('city').value||'Mar del Plata';
    const country=document.getElementById('country').value||'Argentina';
    const tz=document.getElementById('tz').value||'-03:00';
    const date=parseDateTime(dateStr,timeStr,tz);
    const longs=await computeLongitudes(date);

    const canvas=document.getElementById('wheel');
    drawWheel(canvas.getContext('2d'),canvas.width,canvas.height,longs);

    document.getElementById('report').innerHTML=`<b>${name}</b><br/>Sol en ${signOf(longs.Sun)} · Luna en ${signOf(longs.Moon)}<br/>${dateStr} ${timeStr} – ${city}, ${country}`;
  }

  async function downloadPDF(){
    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF();
    pdf.setFillColor(255,230,240);pdf.rect(0,0,595,842,'F');
    pdf.setFontSize(18);pdf.text('Carta Astral – Sanación 11.11',40,40);
    const canvas=document.getElementById('wheel');
    const img=canvas.toDataURL('image/png');
    pdf.addImage(img,'PNG',40,60,500,500);
    pdf.save('Carta_Astral.pdf');
  }

  document.getElementById('btnRender').addEventListener('click',renderAll);
  document.getElementById('btnPdf').addEventListener('click',downloadPDF);
  renderAll();
});
</script>
</body>
</html>
