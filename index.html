<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carta Astral – Sanación 11.11 (Swiss Ephemeris)</title>

<!-- Librerías base -->
<script defer src="https://cdn.jsdelivr.net/npm/astronomy-engine/astronomy.browser.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/html-docx-js/0.4.1/html-docx.min.js"></script>
<script defer src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>

<!-- Swiss Ephemeris (WASM) – con fallback automático -->
<script defer src="https://cdn.jsdelivr.net/npm/swisseph@2.10.4/dist/sweph.js"></script>

<style>
:root{--bg:#ffe6f0;--ink:#2d1b2d;--muted:#6a4c6a;--card:#ffffffcc;--accent:#9b5de5}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1280px;margin:32px auto;padding:0 16px}
header{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin-bottom:16px}
h1{font-size:clamp(20px,3vw,28px);margin:0}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.card{background:var(--card);padding:16px;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08)}
.grid{display:grid;gap:16px}
@media(min-width:1200px){.grid{grid-template-columns:520px 1fr}}
label{font-size:12px;color:var(--muted);margin:10px 0 6px;display:block}
input,select{width:100%;padding:10px;border:1px solid #e6cfe1;border-radius:10px;background:#fff;color:var(--ink)}
input[type="number"]{appearance:textfield}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
button.secondary{background:#fff;color:var(--accent);border:1px solid var(--accent)}
canvas{max-width:100%;height:auto;background:#fff;border-radius:12px}
footer{margin:24px 0;font-size:12px;color:var(--muted);text-align:center}
.hint{font-size:12px;color:var(--muted)}
.alert{background:#fff3cd;color:#7f5f00;border:1px solid #ffe69c;padding:10px;border-radius:10px;margin:0 0 12px;display:none}
.ok{background:#e9f9ef;color:#0f5132;border:1px solid #a3e4c0}
hr.hr{border:none;border-top:1px solid #e6cfe1;margin:12px 0}
.debug{margin:10px 0;padding:8px;border:1px dashed #cfa9d9;border-radius:8px;background:#fff}
.table{width:100%;border-collapse:separate;border-spacing:0 6px}
.table th{font-size:12px;text-transform:uppercase;color:#6a4c6a;text-align:left}
.box{background:#fff;border:1px solid #e6cfe1;border-radius:12px;padding:10px}
.pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3e9fb;color:#5c3ca1;font-weight:600;font-size:12px}
.flex{display:flex;gap:16px;flex-wrap:wrap}
.flex > .box{flex:1 1 300px}
#refImg{max-width:100%;margin-top:10px;display:none;border-radius:12px;background:#fff}

/* mini-leyenda flotante (cúspides) como la caja lateral */
.legend{
  position:relative; margin-top:8px;
  background:#fff;border:1px solid #e6cfe1;border-radius:12px;padding:10px;
  font-family:system-ui,Segoe UI,Roboto,Arial; font-size:12px; color:#2d1b2d;
}
.legend h4{margin:0 0 6px 0; font-size:12px; color:#6a4c6a; text-transform:uppercase}
.legend table{width:100%; border-collapse:separate; border-spacing:0 4px}
.legend td{padding:2px 4px}
.legend .mono{font-family:ui-monospace, Menlo, Consolas, monospace}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>✨ Carta Astral (Swiss Ephemeris)</h1>
    <div class="actions">
      <button id="btnRender" class="secondary">Generar carta</button>
      <button id="btnPdf">Descargar PDF</button>
      <button id="btnDocx">Descargar Word</button>
    </div>
  </header>

  <div id="banner" class="alert"></div>

  <div class="grid">
    <!-- Formulario -->
    <section class="card">
      <label>Nombre completo</label>
      <input id="name" placeholder="Ej: Facundo Rubén Urribarri"/>

      <div class="row3">
        <div><label>Día</label><select id="day"></select></div>
        <div>
          <label>Mes</label>
          <select id="month">
            <option>01</option><option>02</option><option>03</option><option>04</option><option>05</option><option>06</option>
            <option>07</option><option>08</option><option>09</option><option>10</option><option>11</option><option>12</option>
          </select>
        </div>
        <div><label>Año</label><select id="year"></select></div>
      </div>

      <div class="row">
        <div><label>Hora</label><select id="hour"></select></div>
        <div><label>Minutos</label><select id="minute"></select></div>
      </div>

      <div class="row">
        <div><label>Ciudad</label><input id="city" placeholder="Mar del Plata"/></div>
        <div><label>País</label><input id="country" placeholder="Argentina"/></div>
      </div>

      <div class="row">
        <div><label>Latitud (decimal)</label><input id="lat" step="0.0001" placeholder="-38.0000"/></div>
        <div><label>Longitud (decimal)</label><input id="lon" step="0.0001" placeholder="-57.5500"/></div>
      </div>

      <div class="row">
        <div><label>Zona horaria (UTC±hh:mm)</label><input id="tz" placeholder="-03:00"/></div>
        <div><label>Corrección nacimiento (± minutos)</label><input id="deltaMin" type="number" value="0" step="1"/></div>
      </div>

      <p class="hint"><b>Tropical + Placidus</b> por defecto (igual que carta-natal.es). 1° de Asc ≈ 4 min.</p>
      <div id="legend" class="legend" style="display:none"></div>
    </section>

    <!-- Mapa + preview -->
    <section class="card">
      <canvas id="wheel" width="1000" height="1000"></canvas>
      <p class="hint">Cinturón zodiacal con ticks, Placidus real y aspectos (rojo/azul/verde). ℞ aparece si el planeta está retrógrado (Swiss activo).</p>
    </section>
  </div>

  <!-- Paneles tipo CN: posiciones, cúspides, aspectos -->
  <section class="card" style="margin-top:16px">
    <div class="flex">
      <div class="box">
        <div class="pill">Posiciones & Casas</div>
        <table class="table" id="tblPositions"></table>
      </div>
      <div class="box">
        <div class="pill">Cúspides Placidus</div>
        <table class="table" id="tblCusps"></table>
      </div>
      <div class="box">
        <div class="pill">Aspectos</div>
        <table class="table" id="tblAspects"></table>
      </div>
    </div>
  </section>

  <section class="card">
    <div id="report" class="hint">Completá los datos y presioná <b>Generar carta</b>.</div>
  </section>

  <div id="exportArea" style="display:none"></div>
  <footer>© Sanación 11.11 · Interpretación orientativa. Uso exclusivo del/la consultante.</footer>
</div>

<script>
window.addEventListener('load', () => {
  const A = window.Astronomy;
  const banner = document.getElementById('banner');
  function show(msg, ok=false){ banner.style.display='block'; banner.className='alert'+(ok?' ok':''); banner.innerHTML=msg; }
  function hide(){ banner.style.display='none'; }

  // Poblar selects
  const daySel = document.getElementById('day');
  for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=o.textContent=String(d).padStart(2,'0'); daySel.appendChild(o); }
  const yearSel = document.getElementById('year');
  const Y = new Date().getFullYear();
  for(let y=Y; y>=1900; y--){ const o=document.createElement('option'); o.value=o.textContent=String(y); yearSel.appendChild(o); }
  const hourSel = document.getElementById('hour');
  for(let h=0; h<24; h++){ const o=document.createElement('option'); o.value=o.textContent=String(h).padStart(2,'0'); hourSel.appendChild(o); }
  const minSel = document.getElementById('minute');
  for(let m=0; m<60; m++){ const o=document.createElement('option'); o.value=o.textContent=String(m).padStart(2,'0'); minSel.appendChild(o); }

  // Demo (Facundo)
  daySel.value='14'; document.getElementById('month').value='12'; yearSel.value='1986';
  hourSel.value='01'; minSel.value='10';
  document.getElementById('city').value='Mar del Plata';
  document.getElementById('country').value='Argentina';
  document.getElementById('tz').value='-03:00';
  document.getElementById('lat').value='-38.0000';
  document.getElementById('lon').value='-57.5500';

  // ===== Utilidades
  function deg2rad(d){return d*Math.PI/180}
  function rad2deg(r){return r*180/Math.PI}
  function norm360(x){return (x%360+360)%360}
  function eclLonToAngle(lon){return deg2rad((90 - lon + 360) % 360)}
  function signOf(lon){const s=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];return s[Math.floor(norm360(lon)/30)];}
  function parseTZ(tz){ const m=/([+-])(\d{2}):(\d{2})/.exec(tz||'-03:00'); if(!m) return -3; const s=m[1]==='-'?-1:1; return s*(+m[2]+(+m[3]/60)); }
  function buildDate(day,month,year,hour,minute,tz){ const tzH=parseTZ(tz); return new Date(Date.UTC(+year, +month-1, +day, +hour - tzH, +minute)); }
  const obliq = deg2rad(23.4392911);

  // ===== Swiss Ephemeris (WASM) =====
  let SWE=null, SWE_READY=false;
  async function loadSwiss(){
    for(let i=0;i<60;i++){ // ~3s
      if (window.swisseph && window.swisseph.swe_calc_ut){ SWE=window.swisseph; SWE_READY=true; break; }
      await new Promise(r=>setTimeout(r,50));
    }
    if(SWE_READY){ show('Swiss Ephemeris activo ✅', true); setTimeout(hide,1200); }
    else{ show('No se pudo activar Swiss Ephemeris. Uso motor de respaldo.', false); setTimeout(hide,2000); }
  }
  loadSwiss();

  // Longitudes (Swiss si está; si no, fallback)
  async function computeLongitudes(date){
    const out={}, retro={};
    if (SWE_READY && SWE){
      const y=date.getUTCFullYear(), mo=date.getUTCMonth()+1, d=date.getUTCDate();
      const ut=date.getUTCHours()+date.getUTCMinutes()/60+date.getUTCSeconds()/3600;
      const jd=SWE.swe_julday(y,mo,d,ut,SWE.SE_GREG_CAL);
      const flag=SWE.SEFLG_SWIEPH;
      const map={Sun:SWE.SE_SUN, Moon:SWE.SE_MOON, Mercury:SWE.SE_MERCURY, Venus:SWE.SE_VENUS, Mars:SWE.SE_MARS, Jupiter:SWE.SE_JUPITER, Saturn:SWE.SE_SATURN, Uranus:SWE.SE_URANUS, Neptune:SWE.SE_NEPTUNE, Pluto:SWE.SE_PLUTO};
      for(const [k,code] of Object.entries(map)){
        const r=SWE.swe_calc_ut(jd,code,flag);
        if(r.error) throw new Error(r.error);
        out[k]=norm360(r.longitude); retro[k]=(r.speed && r.speed<0);
      }
      return {longs:out, retro};
    }
    const bodies=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto'];
    for(const b of bodies){
      const vec=A.GeoVector(A.Body[b],date,true);
      const ecl=A.Ecliptic(vec);
      out[b]=norm360(rad2deg(ecl.elon)); retro[b]=false;
    }
    return {longs:out, retro};
  }

  // Nodos / Lilith (mean)
  function julianDay(date){ return date.getTime()/86400000 + 2440587.5; }
  function centuriesJ2000(date){ return (julianDay(date) - 2451545.0)/36525.0; }
  function meanLunarNode(date){ const T=centuriesJ2000(date); let omega=125.04455501 - 1934.1361849*T + 0.0020762*T*T + (T*T*T)/467410 - (T*T*T*T)/60616000; return norm360(omega); }
  function meanLilith(date){ const T=centuriesJ2000(date); let L=83.3532465 + 4069.0137287*T - 0.01032*T*T - (T*T*T)/80053 + (T*T*T*T)/18999000; return norm360(L); }

  // ASC/MC y Placidus
  function ramcDeg(date, lonDeg){ const lst=A.SiderealTime(date)*15; return norm360(lst + lonDeg); }
  function mcFromRAMC(ramc){ const α=deg2rad(ramc); const λ=Math.atan2(Math.sin(α)/Math.cos(obliq), Math.cos(α)); return norm360(rad2deg(λ)); }
  function ascFromRAMC(latDeg, ramc){ const φ=deg2rad(latDeg), α=deg2rad(ramc); const num=-((Math.tan(φ)*Math.sin(obliq)) + (Math.sin(α)*Math.cos(obliq))), den=Math.cos(α); return norm360(rad2deg(Math.atan2(den, num))); }
  function eclipticFromRA(raRad){ const x=Math.cos(raRad), y=Math.sin(raRad)/Math.cos(obliq); return norm360(rad2deg(Math.atan2(y,x))); }
  function dsaFromRA(raRad, latDeg){ const φ=deg2rad(latDeg), v=-Math.sin(raRad)*Math.tan(φ)*Math.tan(obliq); return Math.acos(Math.max(-1,Math.min(1,v))); }
  function iterateRA(ramcDeg, latDeg, f, startDeg, noct=false){ const ramc=deg2rad(ramcDeg), raic=ramc+Math.PI; let ra=deg2rad(startDeg); for(let i=0;i<12;i++){ const dsa=dsaFromRA(ra,latDeg); ra = noct ? (raic - f*dsa) : (ramc + f*dsa); } return ra; }
  function getHouseCusps(asc, mc, date, latDeg, lonDeg){
    const RAMC=ramcDeg(date, lonDeg), RAIC=norm360(RAMC+180);
    const ra12=iterateRA(RAMC,latDeg,1/3,RAMC+60,false), ra11=iterateRA(RAMC,latDeg,2/3,RAMC+30,false);
    const ra2 =iterateRA(RAMC,latDeg,2/3,RAIC-60,true),  ra3 =iterateRA(RAMC,latDeg,1/3,RAIC-30,true);
    const c10=mc, c11=eclipticFromRA(ra11), c12=eclipticFromRA(ra12);
    const c1=asc, c2=eclipticFromRA(ra2), c3=eclipticFromRA(ra3);
    const c4=norm360(c10+180), c5=norm360(c11+180), c6=norm360(c12+180);
    const c7=norm360(c1+180),  c8=norm360(c2+180),  c9=norm360(c3+180);
    return [c1,c2,c3,c4,c5,c6,c7,c8,c9,c10,c11,c12];
  }
  function houseOfByCusps(lon, cusps){
    const c=cusps.map(x=>norm360(x)); const seq=[c[0]]; for(let i=1;i<12;i++){let v=c[i]; if(v<seq[i-1]) v+=360; seq.push(v);}
    let L=lon; if(L<seq[0]) L+=360;
    for(let i=0;i<12;i++){ const a=seq[i], b=(i===11)? seq[11]+(seq[1]-seq[0]+360)%360 : seq[i+1]; if(L>=a && L<b) return i+1; }
    return 12;
  }

  // Fortuna
  function sunEquatorialFromEclLon(lon){ const λ=deg2rad(lon); const dec=Math.asin(Math.sin(obliq)*Math.sin(λ)); const ra=Math.atan2(Math.sin(λ)*Math.cos(obliq), Math.cos(λ)); return {ra,dec};}
  function sunAltitude(date, latDeg, lonDeg, sunLon){ const {ra,dec}=sunEquatorialFromEclLon(sunLon); const lst=A.SiderealTime(date)*15*Math.PI/180+deg2rad(lonDeg); const ha=(lst-ra+2*Math.PI)%(2*Math.PI); const lat=deg2rad(latDeg); const sinAlt=Math.sin(lat)*Math.sin(dec)+Math.cos(lat)*Math.cos(dec)*Math.cos(ha); return rad2deg(Math.asin(sinAlt)); }
  function partOfFortune(ascLon, sunLon, moonLon, isDay){ return norm360(isDay ? (ascLon + moonLon - sunLon) : (ascLon - moonLon + sunLon)); }

  // Aspectos
  const ORBS = { conj:8, opp:8, square:6, trine:6, sextile:4 };
  function aspectInfo(d){ if (Math.abs(d-180)<=ORBS.opp) return {color:"#e63946",name:"Oposición",sym:"☍",deg:180};
    if (Math.abs(d-120)<=ORBS.trine) return {color:"#2b77d2",name:"Trígono",sym:"△",deg:120};
    if (Math.abs(d-90)<=ORBS.square) return {color:"#e63946",name:"Cuadratura",sym:"□",deg:90};
    if (Math.abs(d-60)<=ORBS.sextile) return {color:"#2a9d8f",name:"Sextil",sym:"✶",deg:60};
    if (Math.abs(d-0)<=ORBS.conj) return {color:"#e63946",name:"Conjunción",sym:"☌",deg:0};
    return null; }

  // Paleta para signos (parecida a carta-natal.es)
  const SIGN_COLORS={
    Aries:"#d14b4b", Tauro:"#4aa54a", Géminis:"#f0a000", Cáncer:"#4aa1c6",
    Leo:"#e2653a", Virgo:"#4da66a", Libra:"#4f7db9", Escorpio:"#5b5aa7",
    Sagitario:"#d06a3a", Capricornio:"#3a8f6a", Acuario:"#f08f2a", Piscis:"#447ed6"
  };
  const SIGNS=["Aries","Tauro","Géminis","Cáncer","Leo","Virgo","Libra","Escorpio","Sagitario","Capricornio","Acuario","Piscis"];

  // Dibujo
  function drawWheel(ctx,w,h,data,asc,cusps){
    const longs=data.longs, retro=data.retro;
    const cx=w/2,cy=h/2,R=w*0.42,rPlan=R*0.86;
    ctx.clearRect(0,0,w,h);

    // anillo externo con ticks
    ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.fillStyle="#fff";ctx.fill();ctx.strokeStyle="#bfc8e0";ctx.lineWidth=1;ctx.stroke();

    // ticks de 1°, 5°, 10° y signos
    for(let deg=0; deg<360; deg++){
      const a=eclLonToAngle(deg), rOuter=R, rInner=R- (deg%30===0 ? 16 : deg%10===0 ? 12 : deg%5===0 ? 8 : 4);
      ctx.beginPath(); ctx.moveTo(cx+Math.cos(a)*rOuter, cy+Math.sin(a)*rOuter);
      ctx.lineTo(cx+Math.cos(a)*rInner, cy+Math.sin(a)*rInner);
      ctx.strokeStyle = (deg%30===0) ? "#455a8a" : "#cfd6ea"; ctx.lineWidth = (deg%30===0)?2:1;
      ctx.stroke();
    }

    // símbolos de signos grandes en el borde
    ctx.textAlign='center'; ctx.textBaseline='middle';
    for(let i=0;i<12;i++){
      const label=SIGNS[i], a=eclLonToAngle(i*30+15);
      ctx.fillStyle=SIGN_COLORS[label]||"#2d1b2d";
      ctx.font="700 22px system-ui";
      ctx.fillText(label, cx+Math.cos(a)*(R+24), cy+Math.sin(a)*(R+24));
    }

    // rayos de casas
    ctx.save(); ctx.translate(cx,cy);
    for(let i=0;i<12;i++){
      const ang=eclLonToAngle(cusps[i]); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(ang)*R*0.98, Math.sin(ang)*R*0.98); ctx.strokeStyle="#c7a1d8"; ctx.lineWidth=2; ctx.stroke();
      // marca número de casa en anillo intermedio
      const next=cusps[(i+1)%12]; const mid=norm360(cusps[i]+(norm360(next-cusps[i])||360)/2); const am=eclLonToAngle(mid);
      ctx.fillStyle="#9b5de5"; ctx.font="bold 16px Inter"; ctx.fillText(String(i+1), Math.cos(am)*R*0.68, Math.sin(am)*R*0.68);
    }
    // ASC destacado
    const aAsc=eclLonToAngle(asc); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(Math.cos(aAsc)*R, Math.sin(aAsc)*R); ctx.strokeStyle="#9b5de5"; ctx.lineWidth=3; ctx.stroke();
    ctx.restore();

    // aspectos
    const keys=Object.keys(longs).filter(k=>!['Fortuna','SouthNode'].includes(k));
    ctx.lineWidth=1.4;
    for(let i=0;i<keys.length;i++)for(let j=i+1;j<keys.length;j++){
      const d=Math.abs(longs[keys[i]]-longs[keys[j]]); const dd=Math.min(d,360-d);
      const info=aspectInfo(dd); if(!info) continue;
      const a=eclLonToAngle(longs[keys[i]]), b=eclLonToAngle(longs[keys[j]]);
      const x1=cx+Math.cos(a)*rPlan,y1=cy+Math.sin(a)*rPlan,x2=cx+Math.cos(b)*rPlan,y2=cy+Math.sin(b)*rPlan;
      ctx.strokeStyle=info.color; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    }

    // planetas + Fortuna + Nodos + Lilith
    const glyphs={Sun:"☉",Moon:"☽",Mercury:"☿",Venus:"♀",Mars:"♂",Jupiter:"♃",Saturn:"♄",Uranus:"♅",Neptune:"♆",Pluto:"♇",Fortuna:"⊗",NorthNode:"☊",SouthNode:"☋",Lilith:"⚸"};
    ctx.font='20px serif'; ctx.fillStyle='#1f1142';
    for(const k of Object.keys(longs)){
      const ang=eclLonToAngle(longs[k]), x=cx+Math.cos(ang)*rPlan, y=cy+Math.sin(ang)*rPlan;
      ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fillStyle="#fff"; ctx.fill(); ctx.strokeStyle="#cdb0df"; ctx.stroke();
      ctx.fillStyle="#1f1142"; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(glyphs[k]||k[0], x, y);
      if (retro[k]){ ctx.font='12px serif'; ctx.fillText('℞', x+16, y-14); ctx.font='20px serif'; }
    }
  }

  // Helpers de tablas/leyenda
  function fmtDMS(lon){
    const L=norm360(lon); const sign=SIGNS[Math.floor(L/30)];
    const degAll=(L%30); const d=Math.floor(degAll);
    const mAll=(degAll-d)*60; const m=Math.floor(mAll);
    const s=Math.round((mAll-m)*60);
    return {sign, text:`${sign} ${String(d).padStart(2,'0')}°${String(m).padStart(2,'0')}'${String(s).padStart(2,'0')}"`};
  }

  function buildTables(data,cusps,houses){
    const longs=data.longs, retro=data.retro;
    const order=[["Sol","Sun"],["Luna","Moon"],["Mercurio","Mercury"],["Venus","Venus"],["Marte","Mars"],["Júpiter","Jupiter"],["Saturno","Saturn"],["Urano","Uranus"],["Neptuno","Neptune"],["Plutón","Pluto"],["Nodo N (m)","NorthNode"],["Nodo S","SouthNode"],["Lilith (m)","Lilith"],["Fortuna","Fortuna"]];
    const tp=document.getElementById('tblPositions'); tp.innerHTML=""; tp.insertAdjacentHTML('beforeend',`<tr><th>Planeta</th><th>Posición</th><th>Casa</th></tr>`);
    for(const [label,key] of order){
      const {text}=fmtDMS(longs[key]); const c=(houses[key]||"—"); const rx = retro[key] ? " ℞" : "";
      tp.insertAdjacentHTML('beforeend',`<tr><td>${label}</td><td>${text}${rx}</td><td><b>${c}</b></td></tr>`);
    }
    const tc=document.getElementById('tblCusps'); tc.innerHTML=""; tc.insertAdjacentHTML('beforeend',`<tr><th>Casa</th><th>Signo</th></tr>`);
    for(let i=0;i<12;i++){ const {text}=fmtDMS(cusps[i]); const lbl=i===0?"Casa 1 (AC)":i===9?"Casa 10 (MC)":`Casa ${i+1}`; tc.insertAdjacentHTML('beforeend',`<tr><td>${lbl}</td><td>${text}</td></tr>`); }
    const ta=document.getElementById('tblAspects'); ta.innerHTML=""; ta.insertAdjacentHTML('beforeend',`<tr><th>Planeta</th><th>Aspecto</th><th>Planeta</th><th>Orbe</th></tr>`);
    const pts=Object.entries(longs).filter(([k])=>!['Fortuna','SouthNode'].includes(k));
    const rank={red:0,blue:1,green:2}; const aspects=[];
    for(let i=0;i<pts.length;i++)for(let j=i+1;j<pts.length;j++){
      const [ki,ai]=pts[i]; const [kj,aj]=pts[j]; const dd=Math.min(Math.abs(ai-aj),360-Math.abs(ai-aj));
      const info=aspectInfo(dd); if(!info) continue; aspects.push({p1:ki,p2:kj,off:Math.abs(dd-info.deg),info});
    }
    aspects.sort((a,b)=>rank[a.info.color]-rank[b.info.color]||a.off-b.off);
    for(const a of aspects){ ta.insertAdjacentHTML('beforeend',`<tr><td>${a.p1}</td><td>${a.info.sym} ${a.info.name}</td><td>${a.p2}</td><td>${a.off.toFixed(2)}°</td></tr>`); }

    // Leyenda (caja similar a la lateral de tu imagen)
    const lg=document.getElementById('legend'); lg.style.display='block';
    let html='<h4>Cúspides (Placidus)</h4><table>';
    const labels=["AC","2","3","4","5","6","7","8","9","MC","11","12"];
    for(let i=0;i<12;i++){ const {text}=fmtDMS(cusps[i]); html+=`<tr><td>${labels[i]}</td><td class="mono">${text}</td></tr>`; }
    html+='</table>';
    lg.innerHTML=html;
  }

  // Render principal
  async function renderAll(){
    try{
      const day=daySel.value, month=document.getElementById('month').value, year=document.getElementById('year').value;
      const hour=document.getElementById('hour').value, minute=document.getElementById('minute').value, tz=document.getElementById('tz').value||'-03:00';
      const name=(document.getElementById('name').value||'Consultante').trim();
      const city=document.getElementById('city').value||'', country=document.getElementById('country').value||'';
      const lat=parseFloat(document.getElementById('lat').value||-38.0), lon=parseFloat(document.getElementById('lon').value||-57.55);
      const deltaMin=parseInt(document.getElementById('deltaMin').value||0,10);

      const base=buildDate(day,month,year,hour,minute,tz);
      const date=new Date(base.getTime()+deltaMin*60000);

      const data = await computeLongitudes(date); // {longs, retro}

      // Nodos / Lilith
      const nn=meanLunarNode(date), sn=norm360(nn+180), lil=meanLilith(date);
      data.longs.NorthNode=nn; data.longs.SouthNode=sn; data.longs.Lilith=lil; data.retro.NorthNode=false; data.retro.SouthNode=false; data.retro.Lilith=false;

      // Asc/MC/Casas (Placidus)
      const RAMC=ramcDeg(date, lon), mc=mcFromRAMC(RAMC), asc=ascFromRAMC(lat, RAMC);
      const cusps=getHouseCusps(asc, mc, date, lat, lon);

      // Fortuna
      const sunAlt=sunAltitude(date, lat, lon, data.longs.Sun), fortuna=partOfFortune(asc,data.longs.Sun,data.longs.Moon, sunAlt>0);
      data.longs.Fortuna=fortuna; data.retro.Fortuna=false;

      // Casas por punto
      const houses={}; for(const k of Object.keys(data.longs)){ houses[k]=houseOfByCusps(data.longs[k], cusps); }

      // Dibujo
      const canvas=document.getElementById('wheel');
      drawWheel(canvas.getContext('2d'), canvas.width, canvas.height, data, asc, cusps);

      // Paneles y leyenda
      buildTables(data,cusps,houses);

      // Verificación + informe
      function fmt(l){const {text}=fmtDMS(l); return text;}
      const dd=`${day}/${month}/${year}`, tt=`${hour}:${minute}`, place=[city,country].filter(Boolean).join(', ');
      const debug=`<div class="debug"><b>Verificación</b><br>
        UTC: ${date.toISOString()} · ASC: ${fmt(asc)} · MC: ${fmt(mc)}<br>
        Sol: ${fmt(data.longs.Sun)} · Luna: ${fmt(data.longs.Moon)} · NN: ${fmt(nn)} · Lilith: ${fmt(lil)} · Fortuna: ${fmt(fortuna)} (${sunAlt>0?'Día':'Noche'})</div>`;
      const html=`<h3 style="margin:.2em 0">${name}</h3>
        <div><b>Datos:</b> ${dd} · ${tt}${place?` · ${place}`:''} (UTC ${tz})</div>
        <div class="hint">Zodíaco: Tropical · Casas: Placidus · Δ ${deltaMin} min · Efemérides: ${SWE_READY?'Swiss Ephemeris':'Respaldo AE'}</div>
        <hr class="hr"/>
        <p class="hint"><strong>Aviso:</strong> Carta calculada con efemérides astronómicas a partir de los <u>datos exactos de nacimiento</u>. Interpretación orientativa; <em>uso exclusivo del/la consultante</em>.</p>`;
      document.getElementById('report').innerHTML=debug+html;

      // Para Word/PDF (HTML + imagen)
      const imgData=canvas.toDataURL('image/png');
      document.getElementById('exportArea').innerHTML =
        `<h1 style="font-family:Arial">Carta Astral – Sanación 11.11</h1>
         <div><b>${name}</b> · ${dd} ${tt}${place?` – ${place}`:''}</div>
         <div style="margin:8px 0"><small>Tropical · Placidus · Δ ${deltaMin} min · ${SWE_READY?'Swiss Ephemeris':'AE fallback'}</small></div>
         <img src="${imgData}" style="width:620px;height:auto;margin:12px 0"/>
         ${document.getElementById('report').innerHTML}`;
    }catch(e){ console.error(e); show('Error al generar la carta. Revisá la consola (F12).'); }
  }

  // Exportar PDF / Word
  async function downloadPDF(){
    try{
      const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:'a4'});
      pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F');
      pdf.setTextColor(45,27,45); pdf.setFont('helvetica','bold'); pdf.setFontSize(18);
      pdf.text('Carta Astral – Sanación 11.11',40,40);
      const canvas=document.getElementById('wheel'); const img=canvas.toDataURL('image/png');
      const pageW=pdf.internal.pageSize.getWidth()-80; const ratio=pageW/canvas.width; const imgH=canvas.height*ratio;
      pdf.addImage(img,'PNG',40,60,pageW,imgH);
      const rep=document.getElementById('report'); const text=rep.innerText||rep.textContent||'';
      pdf.setFont('helvetica','normal'); pdf.setFontSize(12);
      const lines=pdf.splitTextToSize(text,pageW); let y=80+imgH;
      if(y+lines.length*14>pdf.internal.pageSize.getHeight()-60){ pdf.addPage(); pdf.setFillColor(255,230,240); pdf.rect(0,0,pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight(),'F'); y=60; }
      pdf.text(lines,40,y); pdf.save('Carta_Astral.pdf');
    }catch(e){ console.error(e); show('No se pudo generar el PDF.'); }
  }
  function saveBlob(blob,fn){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=fn; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},800); }
  async function downloadDocx(){
    try{
      const html=`<!DOCTYPE html><html><head><meta charset="utf-8"><style>body{font-family:Arial, sans-serif;line-height:1.35}</style></head><body>${document.getElementById('exportArea').innerHTML}</body></html>`;
      const asBlob=(window.htmlDocx&&window.htmlDocx.asBlob)||(window.HTMLDocx&&window.HTMLDocx.asBlob);
      if(asBlob){ saveBlob(asBlob(html),'Carta_Astral.docx'); return; }
      saveBlob(new Blob(['\ufeff', html],{type:'application/msword'}),'Carta_Astral.doc');
    }catch(e){ console.error(e); show('No se pudo generar el Word.'); }
  }

  // Botones
  document.getElementById('btnRender').addEventListener('click', renderAll);
  document.getElementById('btnPdf').addEventListener('click', downloadPDF);
  document.getElementById('btnDocx').addEventListener('click', downloadDocx);

  // Render inicial
  renderAll();
});
</script>
</body>
</html>
